<!DOCTYPE html>
<html>
<head>
    <title>Amazing Image Identifier</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #00ff85;
            --accent-dim: #00cc6a;
            --bg: #111;
            --bg2: #1a1a1a;
            --bg3: #222;
            --bg4: #2a2a2a;
            --border: #333;
            --text: #eee;
            --text-dim: #888;
            --sidebar-w: 280px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* HEADER */
        .header {
            background: var(--bg2);
            border-bottom: 1px solid var(--border);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .header h1 {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-size: 20px;
            letter-spacing: -0.5px;
        }
        .header p {
            color: var(--text-dim);
            font-size: 13px;
            margin-left: auto;
        }
        .sidebar-toggle {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-dim);
            cursor: pointer;
            padding: 6px 10px;
            font-size: 18px;
            border-radius: 4px;
            transition: 0.2s;
            margin-left: auto;
        }
        .sidebar-toggle:hover { border-color: var(--accent); color: var(--accent); }

        /* LAYOUT */
        .layout {
            display: flex;
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: var(--sidebar-w);
            min-width: var(--sidebar-w);
            background: var(--bg2);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, width 0.3s ease, min-width 0.3s ease;
            overflow: hidden;
        }
        .sidebar.collapsed {
            width: 0;
            min-width: 0;
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .sidebar-header h2 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent);
        }
        .history-count {
            background: var(--bg4);
            color: var(--text-dim);
            font-size: 11px;
            padding: 2px 7px;
            border-radius: 20px;
            font-family: 'JetBrains Mono', monospace;
        }

        .sidebar-clear {
            background: none;
            border: 1px solid #444;
            color: var(--text-dim);
            font-size: 11px;
            padding: 4px 8px;
            cursor: pointer;
            border-radius: 3px;
            font-family: 'JetBrains Mono', monospace;
            transition: 0.2s;
        }
        .sidebar-clear:hover { border-color: #ff4444; color: #ff4444; }

        .history-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }
        .history-list::-webkit-scrollbar { width: 4px; }
        .history-list::-webkit-scrollbar-track { background: var(--bg2); }
        .history-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

        .history-empty {
            padding: 40px 16px;
            text-align: center;
            color: var(--text-dim);
            font-size: 13px;
            line-height: 1.8;
        }
        .history-empty .icon { font-size: 32px; margin-bottom: 12px; opacity: 0.5; }

        .history-item {
            display: flex;
            gap: 10px;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s;
            border: 1px solid transparent;
            margin-bottom: 4px;
            position: relative;
        }
        .history-item:hover { background: var(--bg3); border-color: var(--border); }
        .history-item.active { background: var(--bg3); border-color: var(--accent); }

        .history-thumb {
            width: 52px;
            height: 52px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid var(--border);
            flex-shrink: 0;
            background: var(--bg4);
        }

        .history-info {
            flex: 1;
            overflow: hidden;
        }
        .history-caption {
            font-size: 12px;
            line-height: 1.4;
            color: var(--text);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .history-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 5px;
        }
        .history-obj-count {
            display: inline-block;
            background: var(--bg4);
            color: var(--accent);
            font-size: 10px;
            padding: 1px 5px;
            border-radius: 3px;
            margin-top: 4px;
        }

        .history-delete {
            position: absolute;
            top: 6px;
            right: 6px;
            background: none;
            border: none;
            color: transparent;
            font-size: 12px;
            cursor: pointer;
            padding: 2px 4px;
            border-radius: 3px;
            transition: 0.15s;
            line-height: 1;
        }
        .history-item:hover .history-delete { color: var(--text-dim); }
        .history-delete:hover { background: #ff444422; color: #ff4444 !important; }

        /* MAIN CONTENT */
        .main {
            flex: 1;
            padding: 28px;
            overflow-y: auto;
            max-width: 860px;
        }
        .main::-webkit-scrollbar { width: 4px; }
        .main::-webkit-scrollbar-thumb { background: var(--border); }

        /* UPLOAD AREA */
        .upload-area {
            border: 2px dashed var(--border);
            padding: 48px 40px;
            text-align: center;
            cursor: pointer;
            background: var(--bg2);
            border-radius: 8px;
            transition: 0.2s;
            margin-bottom: 16px;
        }
        .upload-area:hover, .upload-area.drag-over {
            border-color: var(--accent);
            background: #00ff850a;
        }
        .upload-area .icon { font-size: 40px; margin-bottom: 16px; }
        .upload-area h3 { font-size: 17px; margin-bottom: 6px; }
        .upload-area p { color: var(--text-dim); font-size: 13px; }
        input[type=file] { display: none; }

        /* BUTTONS */
        .btn-row { display: flex; gap: 8px; margin-bottom: 20px; }
        .btn {
            background: var(--accent);
            color: #000;
            padding: 12px 24px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            border-radius: 4px;
            transition: 0.2s;
        }
        .btn:hover { background: var(--accent-dim); }
        .btn:disabled { background: #444; color: #666; cursor: not-allowed; }
        .btn-ghost {
            background: var(--bg3);
            color: var(--text-dim);
            border: 1px solid var(--border);
        }
        .btn-ghost:hover { border-color: #555; color: var(--text); background: var(--bg4); }

        /* PREVIEW */
        .preview {
            display: none;
            padding: 16px;
            background: var(--bg2);
            border-radius: 8px;
            border-left: 3px solid var(--accent);
            margin-bottom: 20px;
        }
        .preview.active { display: flex; gap: 16px; align-items: center; }
        .preview img { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; border: 1px solid var(--border); }
        .preview-info h4 { font-size: 14px; color: var(--accent); }
        .preview-info p { font-size: 13px; color: var(--text-dim); margin-top: 4px; }

        /* LOADING */
        #loading {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loading h3 { color: var(--accent); margin-bottom: 8px; }
        #loading p { color: var(--text-dim); font-size: 13px; }

        /* RESULTS */
        .results { display: none; }
        .results.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }
        .results-header h2 {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent);
            font-size: 16px;
        }
        .results-time {
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            color: var(--text-dim);
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        @media (max-width: 600px) { .results-grid { grid-template-columns: 1fr; } }

        .result-card {
            background: var(--bg2);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--border);
        }
        .result-card.full { grid-column: 1 / -1; }
        .result-card h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-dim);
            margin-bottom: 12px;
            font-family: 'JetBrains Mono', monospace;
        }
        .result-card img { width: 100%; border-radius: 4px; border: 1px solid var(--border); }

        #caption { font-size: 15px; line-height: 1.7; color: var(--text); }

        .object-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--bg3);
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 13px;
        }
        .object-label { color: var(--text); }
        .object-conf { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: var(--accent); }
        .conf-bar {
            height: 3px;
            background: var(--border);
            border-radius: 2px;
            margin-top: 5px;
        }
        .conf-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.5s ease; }

        #colors {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .color-chip {
            display: flex;
            align-items: center;
            gap: 7px;
            background: var(--bg3);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
        }
        .color-swatch {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid rgba(255,255,255,0.15);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç IMAGE IDENTIFIER</h1>
        <button class="sidebar-toggle" id="sidebarToggle" title="Toggle History">‚ò∞ History</button>
    </div>

    <div class="layout">
        <!-- SIDEBAR -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>History</h2>
                <span class="history-count" id="historyCount">0</span>
                <button class="sidebar-clear" id="clearHistoryBtn">Clear all</button>
            </div>
            <div class="history-list" id="historyList">
                <div class="history-empty">
                    <div class="icon">üñºÔ∏è</div>
                    <p>Analyzed images<br>will appear here</p>
                </div>
            </div>
        </aside>

        <!-- MAIN -->
        <main class="main">
            <div class="upload-area" id="dropArea">
                <div class="icon">üì∏</div>
                <h3>Upload an Image</h3>
                <p>Click to browse or drag & drop a file</p>
                <p style="margin-top:6px">JPG, PNG ¬∑ Max 10MB ¬∑ Processing 30‚Äì60s on Raspberry Pi</p>
                <input type="file" id="fileInput" accept="image/jpeg,image/png">
            </div>

            <div class="btn-row">
                <button class="btn" id="uploadBtn" disabled>‚ñ∂ Analyze Image</button>
                <button class="btn btn-ghost" id="clearBtn" disabled>‚úï Clear</button>
            </div>

            <div class="preview" id="preview">
                <img id="previewImg" alt="Preview">
                <div class="preview-info">
                    <h4>‚úì Image Ready</h4>
                    <p>Click "Analyze Image" to start</p>
                </div>
            </div>

            <div id="loading">
                <div class="spinner"></div>
                <h3>Analyzing image‚Ä¶</h3>
                <p>30‚Äì60 seconds on Raspberry Pi. Hang tight!</p>
            </div>

            <div class="results" id="results">
                <div class="results-header">
                    <h2>‚úì Analysis Complete</h2>
                    <span class="results-time" id="time"></span>
                </div>

                <div class="results-grid">
                    <div class="result-card full">
                        <h3>Original Image</h3>
                        <img id="originalImage" alt="Analyzed image">
                    </div>

                    <div class="result-card full">
                        <h3>AI Caption</h3>
                        <p id="caption"></p>
                    </div>

                    <div class="result-card">
                        <h3>Detected Objects</h3>
                        <div id="objects"></div>
                    </div>

                    <div class="result-card">
                        <h3>Primary Colors</h3>
                        <div id="colors"></div>
                    </div>

                    <div class="result-card full">
                        <h3>Download Results</h3>
                        <div style="display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap;">
                            <button class="btn" onclick="downloadResults('txt')" style="flex: 1; min-width: 150px;">üìÑ Download TXT</button>
                            <button class="btn" onclick="downloadResults('json')" style="flex: 1; min-width: 150px;">üìä Download JSON</button>
                            <button class="btn" onclick="playAudioReadout()" style="flex: 1; min-width: 150px;">üîä Audio Readout</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ---- State ----
        let selectedFile = null;
        let history = JSON.parse(localStorage.getItem('imgHistory') || '[]');
        let activeHistoryId = null;
        let currentResults = null; // Store current results for downloads

        // ---- Elements ----
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const loading = document.getElementById('loading');
        const preview = document.getElementById('preview');
        const results = document.getElementById('results');
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const historyList = document.getElementById('historyList');
        const historyCount = document.getElementById('historyCount');

        // ---- Sidebar Toggle ----
        sidebarToggle.onclick = () => sidebar.classList.toggle('collapsed');

        // ---- File Handling ----
        dropArea.onclick = () => fileInput.click();

        fileInput.onchange = (e) => {
            if (e.target.files.length > 0) handleFile(e.target.files[0]);
        };

        function handleFile(file) {
            selectedFile = file;
            uploadBtn.disabled = false;
            clearBtn.disabled = false;
            const reader = new FileReader();
            reader.onload = (ev) => {
                document.getElementById('previewImg').src = ev.target.result;
                preview.classList.add('active');
                results.classList.remove('active');
                activeHistoryId = null;
                renderHistory();
            };
            reader.readAsDataURL(file);
        }

        clearBtn.onclick = () => {
            selectedFile = null;
            fileInput.value = '';
            uploadBtn.disabled = true;
            clearBtn.disabled = true;
            results.classList.remove('active');
            preview.classList.remove('active');
            activeHistoryId = null;
            renderHistory();
        };

        // ---- Upload & Analyze ----
        uploadBtn.onclick = async () => {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);

            loading.style.display = 'block';
            preview.classList.remove('active');
            results.classList.remove('active');
            uploadBtn.disabled = true;

            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                const data = await response.json();

                if (data.success) {
                    displayResults(data);
                    saveToHistory(data);
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                    preview.classList.add('active');
                }
            } catch (error) {
                alert('Error: ' + error.message);
                preview.classList.add('active');
            } finally {
                loading.style.display = 'none';
                uploadBtn.disabled = false;
            }
        };

        function displayResults(data) {
            currentResults = data; // Store for downloads
            document.getElementById('originalImage').src = data.original_image;
            document.getElementById('caption').textContent = data.caption;
            document.getElementById('time').textContent = `‚è± ${data.processing_time}s`;

            const objectsDiv = document.getElementById('objects');
            objectsDiv.innerHTML = '';
            if (data.objects && data.objects.length > 0) {
                data.objects.forEach(obj => {
                    const conf = (obj.confidence * 100).toFixed(0);
                    objectsDiv.innerHTML += `
                        <div class="object-item">
                            <span class="object-label">${obj.label}</span>
                            <span class="object-conf">${conf}%</span>
                        </div>
                        <div class="conf-bar"><div class="conf-fill" style="width:${conf}%"></div></div>
                    `;
                });
            } else {
                objectsDiv.innerHTML = '<p style="color:var(--text-dim);font-size:13px">No objects detected</p>';
            }

            const colorsDiv = document.getElementById('colors');
            colorsDiv.innerHTML = '';
            if (data.colors && data.colors.length > 0) {
                data.colors.forEach(c => {
                    colorsDiv.innerHTML += `
                        <div class="color-chip">
                            <div class="color-swatch" style="background:${c}"></div>
                            ${c}
                        </div>`;
                });
            } else {
                colorsDiv.innerHTML = '<p style="color:var(--text-dim);font-size:13px">No colors detected</p>';
            }

            results.classList.add('active');
        }

        // ---- History ----
        function saveToHistory(data) {
            const entry = {
                id: Date.now(),
                timestamp: new Date().toLocaleString(),
                thumb: data.original_image,
                caption: data.caption,
                objects: data.objects || [],
                colors: data.colors || [],
                processing_time: data.processing_time,
                original_image: data.original_image
            };
            history.unshift(entry);
            if (history.length > 50) history = history.slice(0, 50);
            localStorage.setItem('imgHistory', JSON.stringify(history));
            activeHistoryId = entry.id;
            renderHistory();
        }

        function renderHistory() {
            historyCount.textContent = history.length;
            if (history.length === 0) {
                historyList.innerHTML = `
                    <div class="history-empty">
                        <div class="icon">üñºÔ∏è</div>
                        <p>Analyzed images<br>will appear here</p>
                    </div>`;
                return;
            }
            historyList.innerHTML = history.map(item => `
                <div class="history-item ${item.id === activeHistoryId ? 'active' : ''}" 
                     data-id="${item.id}" onclick="loadHistoryItem(${item.id})">
                    <img class="history-thumb" src="${item.thumb}" alt="">
                    <div class="history-info">
                        <div class="history-caption">${item.caption || 'No caption'}</div>
                        <div class="history-meta">${item.timestamp}</div>
                        ${item.objects.length > 0 ? `<span class="history-obj-count">${item.objects.length} object${item.objects.length > 1 ? 's' : ''}</span>` : ''}
                    </div>
                    <button class="history-delete" onclick="deleteHistoryItem(event, ${item.id})">‚úï</button>
                </div>
            `).join('');
        }

        function loadHistoryItem(id) {
            const item = history.find(h => h.id === id);
            if (!item) return;
            activeHistoryId = id;
            selectedFile = null;
            uploadBtn.disabled = true;
            clearBtn.disabled = false;
            preview.classList.remove('active');
            loading.style.display = 'none';
            displayResults({ ...item, success: true });
            renderHistory();
            // scroll main into view on mobile
            document.querySelector('.main').scrollTop = 0;
        }

        function deleteHistoryItem(e, id) {
            e.stopPropagation();
            history = history.filter(h => h.id !== id);
            localStorage.setItem('imgHistory', JSON.stringify(history));
            if (activeHistoryId === id) {
                activeHistoryId = null;
                results.classList.remove('active');
            }
            renderHistory();
        }

        document.getElementById('clearHistoryBtn').onclick = () => {
            if (!confirm('Clear all history?')) return;
            history = [];
            localStorage.setItem('imgHistory', JSON.stringify(history));
            activeHistoryId = null;
            results.classList.remove('active');
            renderHistory();
        };

        // ---- Drag & Drop ----
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
            dropArea.addEventListener(e, evt => { evt.preventDefault(); evt.stopPropagation(); });
        });
        dropArea.addEventListener('dragover', () => dropArea.classList.add('drag-over'));
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('drag-over'));
        dropArea.addEventListener('drop', e => {
            dropArea.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFile(files[0]);
        });

        // ---- Init ----
        renderHistory();

        // ---- Download Results ----
        function downloadResults(format) {
            if (!currentResults) {
                alert('No results to download. Please analyze an image first.');
                return;
            }

            fetch(`/download/${format}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentResults)
            })
            .then(response => {
                if (!response.ok) throw new Error('Download failed');
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analysis.${format}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            })
            .catch(error => {
                console.error('Download error:', error);
                alert('Failed to download results. Please try again.');
            });
        }

        // ---- Audio Readout ----
        function playAudioReadout() {
            if (!currentResults) {
                alert('No results to read. Please analyze an image first.');
                return;
            }

            // Check if browser supports speech synthesis
            if (!('speechSynthesis' in window)) {
                alert('Audio readout is not supported in your browser.');
                return;
            }

            // Build text to speak
            let text = 'Analysis results. ';
            
            // Add caption
            if (currentResults.caption) {
                text += currentResults.caption + '. ';
            }
            
            // Add detected objects
            if (currentResults.objects && currentResults.objects.length > 0) {
                text += `Detected ${currentResults.objects.length} object${currentResults.objects.length > 1 ? 's' : ''}. `;
                currentResults.objects.slice(0, 5).forEach((obj) => {
                    const confidence = Math.round(obj.confidence * 100);
                    text += `${obj.label} with ${confidence} percent confidence. `;
                });
            }
            
            // Add colors
            if (currentResults.colors && currentResults.colors.length > 0) {
                text += `Primary colors are ${currentResults.colors.join(', ')}. `;
            }
            
            // Add processing time
            if (currentResults.processing_time) {
                text += `Processing took ${currentResults.processing_time} seconds.`;
            }

            // Stop any ongoing speech
            speechSynthesis.cancel();

            // Create and speak utterance
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;  // Slightly slower for clarity
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            
            // Optional: Show feedback
            utterance.onstart = () => {
                console.log('Audio readout started');
            };
            
            utterance.onend = () => {
                console.log('Audio readout finished');
            };
            
            utterance.onerror = (event) => {
                console.error('Audio readout error:', event);
                alert('Audio readout failed. Please try again.');
            };

            speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>
