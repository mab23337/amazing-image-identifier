<!DOCTYPE html>
<html>
<head>
    <title>Amazing Image Identifier</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body{font-family:Arial;background:#1a1a1a;color:#fff;padding:20px;margin:0}
        .container{max-width:1200px;margin:0 auto}
        h1{color:#00ff85;margin-bottom:10px}
        .upload-area{border:3px dashed #00ff85;padding:60px;text-align:center;margin:20px 0;cursor:pointer;background:#2a2a2a;transition:0.3s}
        .upload-area:hover{background:#3a3a3a}
        .btn{background:#00ff85;color:#000;padding:15px 30px;border:none;cursor:pointer;font-size:16px;margin:5px;font-weight:bold}
        .btn:disabled{background:#666;cursor:not-allowed}
        .preview{margin-top:20px;padding:20px;background:#2a2a2a;border-left:4px solid #00ff85;display:none}
        .preview.active{display:block}
        .results{margin-top:30px;padding:20px;background:#2a2a2a;display:none;border-left:4px solid #00ff85}
        .results.active{display:block}
        img{max-width:100%;margin:10px 0;border:1px solid #444}
        .object-item{padding:10px;margin:5px 0;background:#3a3a3a}
        #loading{display:none;text-align:center;padding:40px}
        .spinner{border:4px solid #333;border-top:4px solid #00ff85;border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 20px}
        @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Amazing Image Identifier</h1>
        <p>Upload an image to analyze with AI on your Raspberry Pi</p>
        
        <div class="upload-area" id="dropArea">
            <div style="font-size:48px">üì∏</div>
            <p style="margin-top:20px;font-size:18px">Click to upload or drag and drop</p>
            <p style="color:#888">JPG, PNG ‚Ä¢ Max 10MB ‚Ä¢ Processing takes 30-60 seconds</p>
            <input type="file" id="fileInput" accept="image/jpeg,image/png" style="display:none">
        </div>
        
        <button class="btn" id="uploadBtn" disabled>Analyze Image</button>
        <button class="btn" id="clearBtn" style="background:#444" disabled>Clear</button>
        
        <!-- Image Preview (shows before analysis) -->
        <div class="preview" id="preview">
            <h3 style="color:#00ff85">‚úì Image Uploaded</h3>
            <p style="color:#888">Ready to analyze. Click "Analyze Image" button above.</p>
            <img id="previewImg" alt="Preview">
        </div>
        
        <div id="loading">
            <div class="spinner"></div>
            <p style="font-size:20px">ü§ñ Analyzing image...</p>
            <p>This takes 30-60 seconds on Raspberry Pi. Please be patient...</p>
        </div>
        
        <div class="results" id="results">
            <h2 style="color:#00ff85">‚úì Analysis Complete</h2>
            
            <h3 style="margin-top:20px">Original Image:</h3>
            <img id="originalImage" alt="Analyzed image">
            
            <h3 style="margin-top:20px">AI-Generated Caption:</h3>
            <p id="caption" style="font-size:18px;line-height:1.6"></p>
            
            <h3 style="margin-top:20px">Detected Objects:</h3>
            <div id="objects"></div>
            
            <h3 style="margin-top:20px">Primary Colors:</h3>
            <div id="colors" style="padding:10px"></div>
            
            <p style="margin-top:20px;color:#888" id="time"></p>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let currentResults = null;
        
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const loading = document.getElementById('loading');
        const preview = document.getElementById('preview');
        const results = document.getElementById('results');
        
        dropArea.onclick = () => fileInput.click();
        
        fileInput.onchange = (e) => {
            if (e.target.files.length > 0) {
                selectedFile = e.target.files[0];
                uploadBtn.disabled = false;
                clearBtn.disabled = false;
                
                // Show image preview immediately
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('previewImg').src = event.target.result;
                    preview.classList.add('active');
                    results.classList.remove('active');
                };
                reader.readAsDataURL(selectedFile);
            }
        };
        
        clearBtn.onclick = () => {
            selectedFile = null;
            fileInput.value = '';
            uploadBtn.disabled = true;
            clearBtn.disabled = true;
            results.classList.remove('active');
            preview.classList.remove('active');
        };
        
        uploadBtn.onclick = async () => {
            if (!selectedFile) return;
            
            const formData = new FormData();
            formData.append('file', selectedFile);
            
            loading.style.display = 'block';
            preview.classList.remove('active');
            results.classList.remove('active');
            uploadBtn.disabled = true;
            
            try {
                const response = await fetch('/upload', { 
                    method: 'POST', 
                    body: formData 
                });
                const data = await response.json();
                
                if (data.success) {
                    currentResults = data;
                    
                    document.getElementById('originalImage').src = data.original_image;
                    document.getElementById('caption').textContent = data.caption;
                    
                    const objectsDiv = document.getElementById('objects');
                    objectsDiv.innerHTML = '';
                    if (data.objects && data.objects.length > 0) {
                        data.objects.forEach(obj => {
                            const div = document.createElement('div');
                            div.className = 'object-item';
                            div.textContent = `${obj.label}: ${(obj.confidence * 100).toFixed(0)}%`;
                            objectsDiv.appendChild(div);
                        });
                    } else {
                        objectsDiv.innerHTML = '<p style="color:#888">No objects detected</p>';
                    }
                    
                    document.getElementById('colors').textContent = data.colors.join(', ');
                    document.getElementById('time').textContent = `Processing time: ${data.processing_time}s`;
                    
                    results.classList.add('active');
                } else {
                    alert('Error: ' + (data.error || 'Unknown error'));
                    preview.classList.add('active');
                }
            } catch (error) {
                alert('Error: ' + error.message);
                preview.classList.add('active');
            } finally {
                loading.style.display = 'none';
                uploadBtn.disabled = false;
            }
        };
        
        // Drag and drop support
        ['dragenter','dragover','dragleave','drop'].forEach(e => {
            dropArea.addEventListener(e, evt => {evt.preventDefault();evt.stopPropagation()});
        });
        
        dropArea.addEventListener('drop', e => {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                selectedFile = files[0];
                fileInput.files = files;
                uploadBtn.disabled = false;
                clearBtn.disabled = false;
                
                // Show preview for dropped file
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('previewImg').src = event.target.result;
                    preview.classList.add('active');
                    results.classList.remove('active');
                };
                reader.readAsDataURL(selectedFile);
            }
        });
    </script>
</body>
</html>
